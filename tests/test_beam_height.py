import pytest
import numpy as np
import matplotlib.pyplot as plt

from haven.plans.beam_properties import fit_step

@pytest.mark.xfail()
def test_fit_step():
    # Data taken from 25-ID-C scan 927fa7dd-e331-45ca-bb9d-3f89d7c65b17
    x = np.asarray([ 4000.  ,  4098.75,  4196.25,  4295.  ,  4393.75,  4491.25,
        4590.  ,  4688.75,  4787.5 ,  4885.  ,  4983.75,  5082.5 ,
        5180.  ,  5278.75,  5377.5 ,  5475.  ,  5573.75,  5672.5 ,
        5770.  ,  5868.75,  5967.5 ,  6065.  ,  6163.75,  6262.5 ,
        6361.25,  6458.75,  6557.5 ,  6656.25,  6753.75,  6852.5 ,
        6951.25,  7048.75,  7147.5 ,  7246.25,  7343.75,  7442.5 ,
        7541.25,  7638.75,  7737.5 ,  7836.25,  7935.  ,  8032.5 ,
        8131.25,  8230.  ,  8327.5 ,  8426.25,  8525.  ,  8622.5 ,
        8721.25,  8820.  ,  8917.5 ,  9016.25,  9115.  ,  9212.5 ,
        9311.25,  9410.  ,  9508.75,  9606.25,  9705.  ,  9803.75,
        9901.25, 10000.  ])
    y = np.asarray([1986948., 1986762., 1986219., 1985857., 1986368., 1988565.,
       1984304., 1984083., 1984260., 1977423., 1962293., 1934651.,
       1893159., 1831347., 1744330., 1637858., 1518247., 1383126.,
       1251727., 1112157.,  977554.,  845534.,  712432.,  582380.,
        457525.,  347780.,  248174.,  166589.,  105856.,   66173.,
         39880.,   24760.,   16304.,   11544.,    8930.,    7215.,
          6162.,    5401.,    5077.,    4828.,    4620.,    4433.,
          4257.,    4122.,    3988.,    3886.,    3799.,    3711.,
          3622.,    3505.,    3434.,    3392.,    3369.,    3368.,
          3307.,    3309.,    3295.,    3266.,    3290.,    3218.,
          3193.,    3147.])
    expected_center = 5960.94  # 5961.21
    # Do the fitting
    result = fit_step(x, y, plot=True)
    assert result.position == pytest.approx(expected_center)
    assert result.size == 15
